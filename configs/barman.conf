[barman]
;barman_lock_directory = /var/run/barman

; Log location
log_file = /var/log/barman/barman.log

; Log level (see https://docs.python.org/3/library/logging.html#levels)
log_level = INFO

; Pre/post backup hook scripts
;pre_backup_script = env | grep ^BARMAN
;pre_backup_retry_script = env | grep ^BARMAN
;post_backup_retry_script = env | grep ^BARMAN
;post_backup_script = env | grep ^BARMAN

; Pre/post archive hook scripts
;pre_archive_script = env | grep ^BARMAN
;pre_archive_retry_script = env | grep ^BARMAN
;post_archive_retry_script = env | grep ^BARMAN
;post_archive_script = env | grep ^BARMAN

; Pre/post delete scripts
;pre_delete_script = env | grep ^BARMAN
;pre_delete_retry_script = env | grep ^BARMAN
;post_delete_retry_script = env | grep ^BARMAN
;post_delete_script = env | grep ^BARMAN

; Pre/post wal delete scripts
;pre_wal_delete_script = env | grep ^BARMAN
;pre_wal_delete_retry_script = env | grep ^BARMAN
;post_wal_delete_retry_script = env | grep ^BARMAN
;post_wal_delete_script = env | grep ^BARMAN

; Global bandwidth limit in kilobytes per second - default 0 (meaning no limit)
; 50 MB/s - reduces I/O contention with database workload
bandwidth_limit = 50000

; Number of parallel jobs for backup and recovery via rsync (default 1)
; Reduced from 8 to 4 to avoid I/O contention under load
parallel_jobs = 4

; Immediate checkpoint for backup command - default false
; Set to true to force checkpoint before backup, reducing wait time under load
immediate_checkpoint = true

; Enable network compression for data transfers - default false
; Reduces transfer time and network bandwidth usage
network_compression = true

; Number of retries of data copy during base backup after an error - default 0
; Add retry mechanism for transient failures under load
basebackup_retry_times = 2

; Number of seconds of wait after a failed copy, before retrying - default 30
basebackup_retry_sleep = 10

; Maximum execution time, in seconds, per server
; for a barman check command - default 30
;check_timeout = 30

; Time frame that must contain the latest backup date.
; If the latest backup is older than the time frame, barman check
; command will report an error to the user.
; If empty, the latest backup is always considered valid.
; Syntax for this option is: "i (DAYS | WEEKS | MONTHS | HOURS)" where i is an
; integer > 0 which identifies the number of days | weeks | months of
; validity of the latest backup for this check. Also known as 'smelly backup'.
;last_backup_maximum_age =

; Time frame that must contain the latest WAL file
; If the latest WAL file is older than the time frame, barman check
; command will report an error to the user.
; Syntax for this option is: "i (DAYS | WEEKS | MONTHS | HOURS)" where i is an
; integer > 0
;last_wal_maximum_age =

; Minimum number of required backups (redundancy)
;minimum_redundancy = 1

; Global retention policy (REDUNDANCY or RECOVERY WINDOW)
; Examples of retention policies
; Retention policy (disabled, default)
;retention_policy =
; Retention policy (based on redundancy)
;retention_policy = REDUNDANCY 2
; Retention policy (based on recovery window)
;retention_policy = RECOVERY WINDOW OF 4 WEEKS
barman_user = barman
barman_home = /data/pg-backup
compression = pigz
reuse_backup = copy
wal_retention_policy = main
backup_method = rsync
backup_options = concurrent_backup
minimum_redundancy = 1
retention_policy = RECOVERY WINDOW OF 1 DAYS

###########################################
# db1
###########################################
[db1]
archiver = on
description = "SSH db1"
recovery_options = 'get-wal'
conninfo = host=db1 user=postgres dbname=postgres port=5431
ssh_command = ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o BatchMode=yes postgres@db1

###########################################
# db2
###########################################
[db2]
archiver = on
description = "SSH db2"
recovery_options = 'get-wal'
conninfo = host=db2 user=postgres dbname=postgres port=5431
ssh_command = ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o BatchMode=yes postgres@db2

###########################################
# db3
###########################################
[db3]
archiver = on
description = "SSH db3"
recovery_options = 'get-wal'
conninfo = host=db3 user=postgres dbname=postgres port=5431
ssh_command = ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o BatchMode=yes postgres@db3

###########################################
# db4
###########################################
[db4]
archiver = on
description = "SSH db4"
recovery_options = 'get-wal'
conninfo = host=db4 user=postgres dbname=postgres port=5431
ssh_command = ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o BatchMode=yes postgres@db4
