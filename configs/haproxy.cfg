global
    log stdout format raw local0
    stats socket /tmp/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    retries 3

# Stats interface (HTTP mode required for stats)
listen stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend for WRITE operations (routes to leader only)
frontend patroni_write
    bind *:5431
    default_backend patroni_write_backend

# Backend for WRITE operations (leader only)
backend patroni_write_backend
    balance first
    option httpchk GET /master
    http-check expect status 200
    server db1 db1:5431 check port 8001 inter 2000 fall 3 rise 2
    server db2 db2:5431 check port 8001 inter 2000 fall 3 rise 2
    server db3 db3:5431 check port 8001 inter 2000 fall 3 rise 2
    server db4 db4:5431 check port 8001 inter 2000 fall 3 rise 2

# Frontend for READ operations (routes to replicas)
frontend patroni_read
    bind *:5432
    default_backend patroni_read_backend

# Backend for READ operations (replicas only)
# Uses /replica endpoint which returns 200 only for replicas
backend patroni_read_backend
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    server db1 db1:5431 check port 8001 inter 2000 fall 3 rise 2
    server db2 db2:5431 check port 8001 inter 2000 fall 3 rise 2
    server db3 db3:5431 check port 8001 inter 2000 fall 3 rise 2
    server db4 db4:5431 check port 8001 inter 2000 fall 3 rise 2

